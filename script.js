const saranaGhosha = [
    "ōṃ śrī svāminē śaraṇamayyappa",
    "om hari hara sutanē śaraṇamayyappa",
    "om āpadbhāndavanē śaraṇamayyappa",
    "om anādharakṣakanē śaraṇamayyappa",
    "om akhilāṇḍa kōṭi brahmāṇḍanāyakanē śaraṇamayyappa",
    "om annadāna prabhuvē śaraṇamayyappa",
    "om ayyappanē śaraṇamayyappa",
    "om ariyāṅgāvu ayyāvē śaraṇamayyappa",
    "om ārchan kōvil aranē śaraṇamayyappa",
    "om kuḻattapulai bālakanē śaraṇamayyappa",
    "om erumēli śāstanē śaraṇamayyappa",
    "om [vāvarusvāminē śaraṇamayyappa]",
    "om kannimūla mahā gaṇapatiyē śaraṇamayyappa",
    "om nāgarājavē śaraṇamayyappa",
    "om mālikāpuratta dulōkadēvi śaraṇamayyappa mātāyē",
    "om kuruppa svāmiyē śaraṇamayyappa",
    "om sēvippa varkānanda mūrtiyē śaraṇamayyappa",
    "om kāśivāsiyē śaraṇamayyappa",
    "om haridvāra nivāsiyē śaraṇamayyappa",
    "om śrīraṅgapaṭṭaṇa vāsiyē śaraṇamayyappa",
    "om karuppatūr vāsiyē śaraṇamayyappa",
    "om gollapūḍi [dvārapūḍi] dharmaśāstāvē śaraṇamayyappa",
    "om sadguru nādhanē śaraṇamayyappa",
    "om viḻāli vīranē śaraṇamayyappa",
    "om vīramaṇikaṇṭanē śaraṇamayyappa",
    "om dharmaśāstravē śaraṇamayyappa",
    "om śaraṇugōṣapriyavē śaraṇamayyappa",
    "om kāntimalai vāsanē śaraṇamayyappa",
    "om ponnambalavāsiyē śaraṇamayyappa",
    "om pandaḻaśiśuvē śaraṇamayyappa",
    "om vāvarin tōḻanē śaraṇamayyappa",
    "om mōhinīsutavē śaraṇamayyappa",
    "om kankaṇḍa daivamē śaraṇamayyappa",
    "om kaliyugavaradanē śaraṇamayyappa",
    "om sarvarōga nivāraṇa dhanvantara mūrtiyē śaraṇamayyappa",
    "om mahiṣimardananē śaraṇamayyappa",
    "om pūrṇa puṣkaḻa nādhanē śaraṇamayyappa",
    "om van-puli vāhananē śaraṇamayyappa",
    "om baktavatsalanē śaraṇamayyappa",
    "om bhūlōkanādhanē śaraṇamayyappa",
    "om ayindumalaivāsavē śaraṇamayyappa",
    "om śabari girīśanē śaraṇamayyappa",
    "om irumuḍi priyanē śaraṇamayyappa",
    "om abhiṣēkapriyanē śaraṇamayyappa",
    "om vēdappōruḻīnē śaraṇamayyappa",
    "om nitya brahmachāriṇē śaraṇamayyappa",
    "om sarva maṅgaḻadāyakanē śaraṇamayyappa",
    "om vīrādhivīranē śaraṇamayyappa",
    "om ōṅkārappōruḻē śaraṇamayyappa",
    "om ānandarūpanē śaraṇamayyappa",
    "om bhakta chittādivāsanē śaraṇamayyappa",
    "om āśrita-vatsalanē śaraṇamayyappa",
    "om bhūta gaṇādipatayē śaraṇamayyappa",
    "om śakti-rūpanē śaraṇamayyappa",
    "om śāntamūrtayē śaraṇamayyappa",
    "om padunēlbābaḍikki adhipatiyē śaraṇamayyappa",
    "om uttam apuruṣānē śaraṇamayyappa",
    "om ṛṣikula rakṣakunē śaraṇamayyappa",
    "om vēdapriyanē śaraṇamayyappa",
    "om uttarānakṣatra jātakanē śaraṇamayyappa",
    "om tapōdhananē śaraṇamayyappa",
    "om yaṅgaḻa kuladaivamē śaraṇamayyappa",
    "om jaganmōhanē śaraṇamayyappa",
    "om mōhanarūpanē śaraṇamayyappa",
    "om mādhavasutanē śaraṇamayyappa",
    "om yadukulavīranē śaraṇamayyappa",
    "om māmalai vāsanē śaraṇamayyappa",
    "om ṣaṇmukha-sōdaranē śaraṇamayyappa",
    "om vēdāntarūpanē śaraṇamayyappa",
    "om śaṅkara sutanē śaraṇamayyappa",
    "om śatrusaṃhārinē śaraṇamayyappa",
    "om sadguṇamūrtayē śaraṇamayyappa",
    "om parāśaktiyē śaraṇamayyappa",
    "om parātparanē śaraṇamayyappa",
    "om parañjyōtiyē śaraṇamayyappa",
    "om hōmapriyanē śaraṇamayyappa",
    "om gaṇapati sōdaranē śaraṇamayyappa",
    "om dharma śāstrāvē śaraṇamayyappa",
    "om viṣṇusutanē śaraṇamayyappa",
    "om sakala-kaḻā vallabhanē śaraṇamayyappa",
    "om lōka rakṣakanē śaraṇamayyappa",
    "om amita-guṇākaranē śaraṇamayyappa",
    "om alaṅkāra priyanē śaraṇamayyappa",
    "om kannimārai-kappavanē śaraṇamayyappa",
    "om bhuvanēśvaranē śaraṇamayyappa",
    "om mātāpitā gurudaivamē śaraṇamayyappa",
    "om svāmiyin puṅgāvanamē śaraṇamayyappa",
    "om aḻudānadiyē śaraṇamayyappa",
    "om aḻudāmēḍē śaraṇamayyappa",
    "om kaḻliḍraṅkuṇḍrē śaraṇamayyappa",
    "om karimalai yēṭramē śaraṇamayyappa",
    "om karimalai yērakkamē śaraṇamayyappa",
    "om pēriyān vaṭṭamē śaraṇamayyappa",
    "om cheriyāna vaṭṭamē śaraṇamayyappa",
    "om pambānadiyē śaraṇamayyappa",
    "om pambayiḻ vīḻḻakkē śaraṇamayyappa",
    "om nīlimalai yēṭramē śaraṇamayyappa",
    "om appāchi mēḍē śaraṇamayyappa",
    "om śabaripīṭamē śaraṇamayyappa",
    "om śaraṃ gutti ālē śaraṇamayyappa",
    "om bhasmakuḻamē śaraṇamayyappa",
    "om padunēṭṭāṃ baḍiyē śaraṇamayyappa",
    "om neyyībhi ṣēkapriyanē śaraṇamayyappa",
    "om karpūra jyōtiyē śaraṇamayyappa",
    "om jyōtisvarūpanē śaraṇamayyappa",
    "om makara jyōtiyē śaraṇamayyappa",
    "om pandala rājakumāranē śaraṇamayyappa",
    "ōṃ harihara sutanē ānandachittan ayyappa svāminē śaraṇamayyappa"
];

const saranaGhoshaTelugu = [
    "ఓం శ్రీ స్వామినే శరణమయ్యప్ప",
    "ఓం హరి హర సుతనే శరణమయ్యప్ప",
    "ఓం ఆపద్భాందవనే శరణమయ్యప్ప",
    "ఓం అనాధరక్షకనే శరణమయ్యప్ప",
    "ఓం అఖిలాండ కోటి బ్రహ్మాండనాయకనే శరణమయ్యప్ప",
    "ఓం అన్నదాన ప్రభువే శరణమయ్యప్ప",
    "ఓం అయ్యప్పనే శరణమయ్యప్ప",
    "ఓం అరియాంగావు అయ్యావే శరణమయ్యప్ప",
    "ఓం ఆర్చన్ కోవిల్ అరనే శరణమయ్యప్ప",
    "ఓం కుళత్తపులై బాలకనే శరణమయ్యప్ప",
    "ఓం ఎరుమేలి శాస్తనే శరణమయ్యప్ప",
    "ఓం [వావరుస్వామినే శరణమయ్యప్ప]",
    "ఓం కన్నిమూల మహా గణపతియే శరణమయ్యప్ప",
    "ఓం నాగరాజవే శరణమయ్యప్ప",
    "ఓం మాలికాపురత్త దులోకదేవి శరణమయ్యప్ప మాతాయే",
    "ఓం కురుప్ప స్వామియే శరణమయ్యప్ప",
    "ఓం సేవిప్ప వర్కానంద మూర్తియే శరణమయ్యప్ప",
    "ఓం కాశివాసియే శరణమయ్యప్ప",
    "ఓం హరిద్వార నివాసియే శరణమయ్యప్ప",
    "ఓం శ్రీరంగపట్టణ వాసియే శరణమయ్యప్ప",
    "ఓం కరుప్పతూర్ వాసియే శరణమయ్యప్ప",
    "ఓం గొల్లపూడి [ద్వారపూడి] ధర్మశాస్తావే శరణమయ్యప్ప",
    "ఓం సద్గురు నాధనే శరణమయ్యప్ప",
    "ఓం విళాలి వీరనే శరణమయ్యప్ప",
    "ఓం వీరమణికంటనే శరణమయ్యప్ప",
    "ఓం ధర్మశాస్త్రవే శరణమయ్యప్ప",
    "ఓం శరణుగోషప్రియవే శరణమయ్యప్ప",
    "ఓం కాంతిమలై వాసనే శరణమయ్యప్ప",
    "ఓం పొన్నంబలవాసియే శరణమయ్యప్ప",
    "ఓం పందళశిశువే శరణమయ్యప్ప",
    "ఓం వావరిన్ తోళనే శరణమయ్యప్ప",
    "ఓం మోహినీసుతవే శరణమయ్యప్ప",
    "ఓం కన్కండ దైవమే శరణమయ్యప్ప",
    "ఓం కలియుగవరదనే శరణమయ్యప్ప",
    "ఓం సర్వరోగ నివారణ ధన్వంతర మూర్తియే శరణమయ్యప్ప",
    "ఓం మహిషిమర్దననే శరణమయ్యప్ప",
    "ఓం పూర్ణ పుష్కళ నాధనే శరణమయ్యప్ప",
    "ఓం వన్-పులి వాహననే శరణమయ్యప్ప",
    "ఓం బక్తవత్సలనే శరణమయ్యప్ప",
    "ఓం భూలోకనాధనే శరణమయ్యప్ప",
    "ఓం అయిందుమలైవాసవే శరణమయ్యప్ప",
    "ఓం శబరి గిరీశనే శరణమయ్యప్ప",
    "ఓం ఇరుముడి ప్రియనే శరణమయ్యప్ప",
    "ఓం అభిషేకప్రియనే శరణమయ్యప్ప",
    "ఓం వేదప్పోరుళీనే శరణమయ్యప్ప",
    "ఓం నిత్య బ్రహ్మచారిణే శరణమయ్యప్ప",
    "ఓం సర్వ మంగళదాయకనే శరణమయ్యప్ప",
    "ఓం వీరాధివీరనే శరణమయ్యప్ప",
    "ఓం ఓంకారప్పోరుళే శరణమయ్యప్ప",
    "ఓం ఆనందరూపనే శరణమయ్యప్ప",
    "ఓం భక్త చిత్తాదివాసనే శరణమయ్యప్ప",
    "ఓం ఆశ్రిత-వత్సలనే శరణమయ్యప్ప",
    "ఓం భూత గణాదిపతయే శరణమయ్యప్ప",
    "ఓం శక్తి-రూపనే శరణమయ్యప్ప",
    "ఓం శాంతమూర్తయే శరణమయ్యప్ప",
    "ఓం పదునేల్బాబడిక్కి అధిపతియే శరణమయ్యప్ప",
    "ఓం ఉత్తమపురుషానే శరణమయ్యప్ప",
    "ఓం ఋషికుల రక్షకునే శరణమయ్యప్ప",
    "ఓం వేదప్రియనే శరణమయ్యప్ప",
    "ఓం ఉత్తరానక్షత్ర జాతకనే శరణమయ్యప్ప",
    "ఓం తపోధననే శరణమయ్యప్ప",
    "ఓం యంగళ కులదైవమే శరణమయ్యప్ప",
    "ఓం జగన్మోహనే శరణమయ్యప్ప",
    "ఓం మోహనరూపనే శరణమయ్యప్ప",
    "ఓం మాధవసుతనే శరణమయ్యప్ప",
    "ఓం యదుకులవీరనే శరణమయ్యప్ప",
    "ఓం మామలై వాసనే శరణమయ్యప్ప",
    "ఓం షణ్ముఖ-సోదరనే శరణమయ్యప్ప",
    "ఓం వేదాంతరూపనే శరణమయ్యప్ప",
    "ఓం శంకర సుతనే శరణమయ్యప్ప",
    "ఓం శత్రుసంహారినే శరణమయ్యప్ప",
    "ఓం సద్గుణమూర్తయే శరణమయ్యప్ప",
    "ఓం పరాశక్తియే శరణమయ్యప్ప",
    "ఓం పరాత్పరనే శరణమయ్యప్ప",
    "ఓం పరంజ్యోతియే శరణమయ్యప్ప",
    "ఓం హోమప్రియనే శరణమయ్యప్ప",
    "ఓం గణపతి సోదరనే శరణమయ్యప్ప",
    "ఓం ధర్మ శాస్త్రావే శరణమయ్యప్ప",
    "ఓం విష్ణుసుతనే శరణమయ్యప్ప",
    "ఓం సకల-కళా వల్లభనే శరణమయ్యప్ప",
    "ఓం లోక రక్షకనే శరణమయ్యప్ప",
    "ఓం అమిత-గుణాకరనే శరణమయ్యప్ప",
    "ఓం అలంకార ప్రియనే శరణమయ్యప్ప",
    "ఓం కన్నిమారై-కప్పవనే శరణమయ్యప్ప",
    "ఓం భువనేశ్వరనే శరణమయ్యప్ప",
    "ఓం మాతాపితా గురుదైవమే శరణమయ్యప్ప",
    "ఓం స్వామియిన్ పుంగావనమే శరణమయ్యప్ప",
    "ఓం అళుదానదియే శరణమయ్యప్ప",
    "ఓం అళుదామేడే శరణమయ్యప్ప",
    "ఓం కళ్లిడ్రంకుండ్రే శరణమయ్యప్ప",
    "ఓం కరిమలై యేట్రమే శరణమయ్యప్ప",
    "ఓం కరిమలై యేరక్కమే శరణమయ్యప్ప",
    "ఓం పేరియాన్ వట్టమే శరణమయ్యప్ప",
    "ఓం చెరియాన వట్టమే శరణమయ్యప్ప",
    "ఓం పంబానదియే శరణమయ్యప్ప",
    "ఓం పంబయిళ్ వీళ్ళక్కే శరణమయ్యప్ప",
    "ఓం నీలిమలై యేట్రమే శరణమయ్యప్ప",
    "ఓం అప్పాచి మేడే శరణమయ్యప్ప",
    "ఓం శబరిపీటమే శరణమయ్యప్ప",
    "ఓం శరం గుత్తి ఆలే శరణమయ్యప్ప",
    "ఓం భస్మకుళమే శరణమయ్యప్ప",
    "ఓం పదునేట్టాం బడియే శరణమయ్యప్ప",
    "ఓం నెయ్యీభి షేకప్రియనే శరణమయ్యప్ప",
    "ఓం కర్పూర జ్యోతియే శరణమయ్యప్ప",
    "ఓం జ్యోతిస్వరూపనే శరణమయ్యప్ప",
    "ఓం మకర జ్యోతియే శరణమయ్యప్ప",
    "ఓం పందల రాజకుమారనే శరణమయ్యప్ప",
    "ఓం హరిహర సుతనే ఆనందచిత్తన్ అయ్యప్ప స్వామినే శరణమయ్యప్ప"
];

const naamaJapamEnglish = Array(108).fill("Om Sri Swamiye Saranam Ayyappa");
const naamaJapamTelugu = Array(108).fill("ఓం శ్రీ స్వామియే శరణం అయ్యప్ప");

const englishSlogans = [
    "svāmi śaraṇaṃ – ayyappa śaraṇaṃ",
    "bhagavān śaraṇaṃ – bhagavati śaraṇaṃ",
    "dēvan śaraṇaṃ – dēvī śaraṇaṃ",
    "dēvan pādaṃ – dēvī pādaṃ",
    "svāmi pādaṃ – ayyappa pādaṃ",
    "bhagavānē – bhagavatiyē",
    "īśvaranē – īśvariyē",
    "dēvanē – dēviyē",
    "śaktanē – śaktiyē",
    "svāmiyē – ayyapō",
    "pallikaṭṭu – śabarimalakku",
    "irumuḍikaṭṭu – śabarimalakku",
    "kattuṅkaṭṭu – śabarimalakku",
    "kallummulluṃ – kālikimettai",
    "ettiviḍayyā – tūkikkaviḍayyā",
    "dēhabalandā – pādabalandā",
    "yāraikāna – svāmiyaikāna",
    "svāmiyaikaṇḍāl – mōkṣaṅkiṭṭuṃ",
    "svāmimārē – ayyappamārē",
    "neyyābhiṣēkaṃ – svāmikkē",
    "karpūradīpaṃ – svāmikkē",
    "pālābhiṣēkaṃ – svāmikkē",
    "bhasmābhiṣēkaṃ – svāmikkē",
    "tēnābhiṣēkaṃ – svāmikkē",
    "chandanābhiṣēkaṃ – svāmikkē",
    "pūlābhiṣēkaṃ – svāmikkē",
    "pannīrābhiṣēkaṃ – svāmikkē",
    "pambāśisuvē – ayyappā",
    "kānanavāsā – ayyappā",
    "śabarigirīśā – ayyappā",
    "pandaḻarājā – ayyappā",
    "pambāvāsā – ayyappā",
    "van‍pulivāhana – ayyappā",
    "sundararūpā – ayyappā",
    "ṣaṇmugasōdara – ayyappā",
    "mōhinitanayā – ayyappā",
    "gaṇēśasōdara – ayyappā",
    "hariharatanayā – ayyappā",
    "anādharakṣaka – ayyappā",
    "sadgurunāthā – ayyappā",
    "svāmiyē – ayyappō",
    "ayyappō – svāmiyē",
    "svāmi śaraṇaṃ – ayyappa śaraṇaṃ"
];

const teluguSlogans = [
    "స్వామి శరణం – అయ్యప్ప శరణం",
    "భగవాన్ శరణం – భగవతి శరణం",
    "దేవన్ శరణం – దేవీ శరణం",
    "దేవన్ పాదం – దేవీ పాదం",
    "స్వామి పాదం – అయ్యప్ప పాదం",
    "భగవానే – భగవతియే",
    "ఈశ్వరనే – ఈశ్వరియే",
    "దేవనే – దేవియే",
    "శక్తనే – శక్తియే",
    "స్వామియే – అయ్యపో",
    "పల్లికట్టు – శబరిమలక్కు",
    "ఇరుముడికట్టు – శబరిమలక్కు",
    "కత్తుంకట్టు – శబరిమలక్కు",
    "కల్లుంముల్లుం – కాలికిమెత్తై",
    "ఎత్తివిడయ్యా – తూకిక్కవిడయ్యా",
    "దేహబలందా – పాదబలందా",
    "యారైకాన – స్వామియైకాన",
    "స్వామియైకండాల్ – మోక్షంకిట్టుం",
    "స్వామిమారే – అయ్యప్పమారే",
    "నెయ్యాభిషేకం – స్వామిక్కే",
    "కర్పూరదీపం – స్వామిక్కే",
    "పాలాభిషేకం – స్వామిక్కే",
    "భస్మాభిషేకం – స్వామిక్కే",
    "తేనాభిషేకం – స్వామిక్కే",
    "చందనాభిషేకం – స్వామిక్కే",
    "పూలాభిషేకం – స్వామిక్కే",
    "పన్నీరాభిషేకం – స్వామిక్కే",
    "పంబాశిసువే – అయ్యప్పా",
    "కాననవాసా – అయ్యప్పా",
    "శబరిగిరీశా – అయ్యప్పా",
    "పందళరాజా – అయ్యప్పా",
    "పంబావాసా – అయ్యప్పా",
    "వన్‍పులివాహన – అయ్యప్పా",
    "సుందరరూపా – అయ్యప్పా",
    "షణ్ముగసోదర – అయ్యప్పా",
    "మోహినితనయా – అయ్యప్పా",
    "గణేశసోదర – అయ్యప్పా",
    "హరిహరతనయా – అయ్యప్పా",
    "అనాధరక్షక – అయ్యప్పా",
    "సద్గురునాథా – అయ్యప్పా",
    "స్వామియే – అయ్యప్పో",
    "అయ్యప్పో – స్వామియే",
    "స్వామి శరణం – అయ్యప్ప శరణం"
];

document.addEventListener('DOMContentLoaded', () => {
    const hamburgerBtn = document.querySelector('.hamburger-btn');
    const headerControls = document.querySelector('.header-controls');

    hamburgerBtn.addEventListener('click', () => {
        hamburgerBtn.classList.toggle('is-active');
        headerControls.classList.toggle('nav-active');
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (headerControls.classList.contains('nav-active') &&
            !headerControls.contains(e.target) &&
            !hamburgerBtn.contains(e.target)) {

            hamburgerBtn.classList.remove('is-active');
            headerControls.classList.remove('nav-active');
        }
    });

    const stepsContainer = document.getElementById('steps-container');
    const progressBar = document.getElementById('progress-bar');
    const progressLabel = document.getElementById('progress-label');
    const startTimeElement = document.getElementById('start-time');
    const endTimeElement = document.getElementById('end-time');
    const languageToggle = document.getElementById('language-toggle');
    const modeToggle = document.getElementById('mode-toggle');
    const body = document.body;
    const totalSteps = 108;
    const historyList = document.getElementById('history-list');
    const clearHistoryButton = document.getElementById('clear-history');
    const audioCheckbox = document.getElementById('audio-checkbox');
    const audio = document.getElementById('background-music');
    const slogansButton = document.getElementById('slogans-button');
    const slogansModal = document.getElementById('slogans-modal');
    const modalCloseButton = document.getElementById('modal-close-button');
    const slogansContainer = document.getElementById('slogans-container');

    slogansButton.addEventListener('click', () => {
        const slogans = currentLanguage === 'telugu' ? teluguSlogans : englishSlogans;
        slogansContainer.innerHTML = slogans.map(s => `<div class="slogan-card"><p>${s}</p></div>`).join('');
        slogansModal.style.display = 'flex';
    });

    modalCloseButton.addEventListener('click', () => {
        slogansModal.style.display = 'none';
    });

    slogansModal.addEventListener('click', (e) => {
        if (e.target === slogansModal) {
            slogansModal.style.display = 'none';
        }
    });


    audioCheckbox.addEventListener('change', () => {
        if (audioCheckbox.checked) {
            audio.play();
        } else {
            audio.pause();
        }
    });

    let startTime = null;
    let endTime = null;
    let currentLanguage = localStorage.getItem('language') || 'telugu';
    let currentMode = localStorage.getItem('mode') || 'ghosha';
    let currentTheme = localStorage.getItem('theme') || 'dark-mode';

    const btnLangEn = document.getElementById('btn-lang-en');
    const btnLangTe = document.getElementById('btn-lang-te');
    const languageControl = document.querySelector('.segment-control-container');

    // Language switching
    function updateLanguageUI(lang) {
        if (lang === 'telugu') {
            btnLangTe.classList.add('active');
            btnLangEn.classList.remove('active');
            document.documentElement.lang = 'te';
        } else {
            btnLangEn.classList.add('active');
            btnLangTe.classList.remove('active');
            document.documentElement.lang = 'en';
        }
        localStorage.setItem('language', lang);
        currentLanguage = lang;
        generateSteps();
    }

    // Initialize UI
    updateLanguageUI(currentLanguage);

    btnLangEn.addEventListener('click', () => updateLanguageUI('english'));
    btnLangTe.addEventListener('click', () => updateLanguageUI('telugu'));

    const btnModeGhosha = document.getElementById('btn-mode-ghosha');
    const btnModeJapam = document.getElementById('btn-mode-japam');

    // Mode switching
    function updateModeUI(mode) {
        if (mode === 'japam') {
            btnModeJapam.classList.add('active');
            btnModeGhosha.classList.remove('active');
        } else {
            btnModeGhosha.classList.add('active');
            btnModeJapam.classList.remove('active');
        }
        localStorage.setItem('mode', mode);
        currentMode = mode;
        generateSteps();
    }

    // Initialize UI
    updateModeUI(currentMode);

    btnModeGhosha.addEventListener('click', () => updateModeUI('ghosha'));
    btnModeJapam.addEventListener('click', () => updateModeUI('japam'));

    // Theme switching
    const themeBtn = document.getElementById('theme-btn');
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');

    function updateThemeUI(theme) {
        if (theme === 'dark-mode') {
            body.classList.add('dark-mode');
            sunIcon.style.display = 'block';
            moonIcon.style.display = 'none';
        } else {
            body.classList.remove('dark-mode');
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'block';
        }
        localStorage.setItem('theme', theme);
        currentTheme = theme;
    }

    updateThemeUI(currentTheme);

    themeBtn.addEventListener('click', () => {
        const newTheme = body.classList.contains('dark-mode') ? 'light-mode' : 'dark-mode';
        updateThemeUI(newTheme);
    });

    function formatTime(date) {
        if (!date) return '-';
        let hours = date.getHours();
        let minutes = date.getMinutes();
        let ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; // the hour '0' should be '12'
        minutes = minutes < 10 ? '0' + minutes : minutes;
        let strTime = hours + ':' + minutes + ' ' + ampm;
        return strTime;
    }

    function updateProgress() {
        const checkedBoxes = document.querySelectorAll('.step input[type="checkbox"]:checked');
        const checkedCount = checkedBoxes.length;
        const percentage = (checkedCount / totalSteps) * 100;

        progressBar.style.width = `${percentage}%`;
        progressLabel.textContent = `${Math.round(percentage)}%`;
        progressBar.setAttribute('aria-valuenow', Math.round(percentage));

        // Handle start time
        if (checkedCount > 0 && !startTime) {
            startTime = new Date();
            startTimeElement.textContent = formatTime(startTime);
        } else if (checkedCount === 0) {
            startTime = null;
            startTimeElement.textContent = '-';
        }

        // Handle end time
        if (checkedCount === totalSteps && !endTime) {
            endTime = new Date();
            endTimeElement.textContent = formatTime(endTime);
            saveHistory(endTime);
        } else if (checkedCount < totalSteps) {
            endTime = null;
            endTimeElement.textContent = '-';
        }
    }

    function generateSteps() {
        stepsContainer.innerHTML = '';
        let ghosha;

        if (currentMode === 'japam') {
            ghosha = currentLanguage === 'telugu' ? naamaJapamTelugu : naamaJapamEnglish;
        } else {
            ghosha = currentLanguage === 'telugu' ? saranaGhoshaTelugu : saranaGhosha;
        }

        for (let i = 1; i <= totalSteps; i++) {
            const stepElement = document.createElement('div');
            stepElement.classList.add('step');

            const label = document.createElement('label');
            label.classList.add('ios-checkbox');

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `step-${i}`;
            checkbox.addEventListener('change', () => {
                updateProgress();
                // Haptic Feedback
                if (navigator.vibrate) {
                    navigator.vibrate(20);
                }
            });

            const checkboxWrapper = document.createElement('div');
            checkboxWrapper.classList.add('checkbox-wrapper');
            checkboxWrapper.innerHTML = `
                <div class="checkbox-bg"></div>
                <svg class="checkbox-icon" viewBox="0 0 24 24" fill="none">
                    <path class="check-path" d="M4 12L10 18L20 6" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
            `;

            label.appendChild(checkbox);
            label.appendChild(checkboxWrapper);

            const stepNumber = document.createElement('span');
            stepNumber.classList.add('step-number');
            stepNumber.textContent = `${i}.`;

            const title = document.createElement('span');
            title.classList.add('step-title');
            title.textContent = ghosha[i - 1] || `Step ${i}`;

            stepElement.appendChild(label);
            stepElement.appendChild(stepNumber);
            stepElement.appendChild(title);

            // Touch-friendly: Toggle checkbox when clicking anywhere in the row
            stepElement.addEventListener('click', (e) => {
                // Determine if we clicked specifically on the interaction elements
                // The label (and its children) handles the click natively, so ignore those
                if (!label.contains(e.target)) {
                    // Checkbox state toggle is handled by the click, but we need to trigger it
                    // safely. Direct assignment doesn't fire 'change', click() does.
                    checkbox.click();
                }
            });

            stepsContainer.appendChild(stepElement);
        }
        updateProgress();
    }

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('pradakshinaHistory')) || [];
        historyList.innerHTML = '';
        for (const item of history) {
            const li = document.createElement('li');
            li.textContent = item;
            historyList.appendChild(li);
        }
    }

    function saveHistory(completionTime) {
        const history = JSON.parse(localStorage.getItem('pradakshinaHistory')) || [];
        const completionString = `${completionTime.toLocaleDateString()} ${formatTime(completionTime)}`;
        history.push(completionString);
        localStorage.setItem('pradakshinaHistory', JSON.stringify(history));
        loadHistory();
    }

    function clearHistory() {
        if (confirm('Are you sure you want to clear the history?')) {
            localStorage.removeItem('pradakshinaHistory');
            loadHistory();
        }
    }

    clearHistoryButton.addEventListener('click', clearHistory);

    // Initial generation
    generateSteps();
    loadHistory();
});